From c82913cc2e6e249a3efba76ae81a2a74c5d57d34 Mon Sep 17 00:00:00 2001
From: David Hoppenbrouwers <david@salt-inc.org>
Date: Fri, 3 Jun 2022 03:21:52 +0200
Subject: [PATCH 42/45] Remove query calls

---
 library/std/src/sys/norostb/fs.rs | 14 +++++++++++---
 1 file changed, 11 insertions(+), 3 deletions(-)

diff --git a/library/std/src/sys/norostb/fs.rs b/library/std/src/sys/norostb/fs.rs
index 3749c8709a9..eccae53ce7c 100644
--- a/library/std/src/sys/norostb/fs.rs
+++ b/library/std/src/sys/norostb/fs.rs
@@ -31,7 +31,7 @@
 pub enum FileAttr {}
 
 #[derive(Debug)]
-pub struct ReadDir(rt_io::Query);
+pub struct ReadDir(Object);
 
 #[derive(Clone, Debug)]
 pub struct DirEntry(OsString);
@@ -112,7 +112,15 @@ impl Iterator for ReadDir {
     type Item = io::Result<DirEntry>;
 
     fn next(&mut self) -> Option<io::Result<DirEntry>> {
-        self.0.next().map(|path| Ok(DirEntry(OsString::from_vec(path))))
+        let mut path = Vec::from([0; 4096]);
+        self.0
+            .read(&mut path)
+            .map(|l| (l > 0).then(|| {
+                path.resize(l, 0);
+                DirEntry(OsString::from_vec(path))
+            }))
+            .map_err(cvt_err)
+            .transpose()
     }
 }
 
@@ -248,7 +256,7 @@ pub fn mkdir(&self, _p: &Path) -> io::Result<()> {
 pub fn readdir(path: &Path) -> io::Result<ReadDir> {
     rt_io::file_root()
         .ok_or(super::ERR_UNSET)?
-        .query(path_inner(path))
+        .open(path_inner(path))
         .map(ReadDir)
         .map_err(cvt_err)
 }
-- 
2.30.2

