From 39a73d736d910e60b43444463c9c100b438610c1 Mon Sep 17 00:00:00 2001
From: David Hoppenbrouwers <david@salt-inc.org>
Date: Sun, 17 Apr 2022 19:43:22 +0200
Subject: [PATCH 18/41] Implement I/O poll

---
 library/std/src/os/norostb/mod.rs |  4 +++-
 library/std/src/sys/norostb/io.rs | 12 ++++++++++++
 2 files changed, 15 insertions(+), 1 deletion(-)

diff --git a/library/std/src/os/norostb/mod.rs b/library/std/src/os/norostb/mod.rs
index ab7f3a69c68..0ca072765d6 100644
--- a/library/std/src/os/norostb/mod.rs
+++ b/library/std/src/os/norostb/mod.rs
@@ -2,5 +2,7 @@
 
 pub mod ffi;
 
-pub use crate::sys::io::{create, finish_job, open, query, query_next, read, take_job, write};
+pub use crate::sys::io::{
+    create, finish_job, open, poll, query, query_next, read, seek, take_job, write,
+};
 pub use norostb_rt::kernel::io::{Job, ObjectInfo};
diff --git a/library/std/src/sys/norostb/io.rs b/library/std/src/sys/norostb/io.rs
index e454e70d1b1..085f7bf5cda 100644
--- a/library/std/src/sys/norostb/io.rs
+++ b/library/std/src/sys/norostb/io.rs
@@ -224,6 +224,18 @@ pub fn seek(handle: syscall::Handle, from: io::SeekFrom) -> io::Result<u64> {
     }
 }
 
+/// Blocking poll
+#[unstable(feature = "norostb", issue = "none")]
+#[inline]
+pub fn poll(handle: syscall::Handle) -> io::Result<usize> {
+    let e = enqueue(Request::poll(0, handle));
+    if e.value < 0 {
+        Err(io::const_io_error!(io::ErrorKind::Uncategorized, "failed to poll"))
+    } else {
+        Ok(e.value as usize)
+    }
+}
+
 /// Create an iterator over all tables.
 #[unstable(feature = "norostb", issue = "none")]
 #[inline]
-- 
2.30.2

